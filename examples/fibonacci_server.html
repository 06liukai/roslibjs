<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script src="../include/EventEmitter2/eventemitter2.js"></script>
<script src="../build/roslib.js"></script>

<script>
  // Connecting to ROS
  // -----------------
  var ros = new ROSLIB.Ros({
    url : 'ws://localhost:9090'
  });

  // If there is an error on the backend, an 'error' emit will be emitted.
  ros.on('error', function(error) {
    console.log(error);
  });

  // The ActionServer
  // ----------------

  this.fibonacciServer = new ROSLIB.ActionServer({
    ros : ros,
    serverName : '/fibonacci',
    actionName : 'actionlib_tutorials/FibonacciAction'
  });

  this.canceled = false;
  that=this;

  //handle fibonacci action request.
  this.fibonacciServer.on('goal', function(goalMessage) {
    fibonacciSequence = [];
    fibonacciSequence.push(0);
    fibonacciSequence.push(1);

    for (var i = 1; i < goal.order; i++ ) {
      fibonacciSequence.push( fibonacciSequence[i] + fibonacciSequence[i-1] );

      if (that.canceled === true ) {
        console.log("Action server preempted");
        
        that.fibonacciServer.setPreempted();
      }

      //send feedback
      that.fibonacciServer.sendFeedback(fibonacciSequence);
    }      
    //send result
    that.fibonacciServer.setSucceeded(fibonacciSequence);
  });

  this.fibonacciServer.on('cancel', function(goalMessage){
    that.canceled = true;

  });

  // Create a goal.
  var goal = new ROSLIB.Goal({
    actionClient : fibonacciClient,
    goalMessage : {
      order : 7
    }
  });

  // Print out their output into the terminal.
  goal.on('feedback', function(feedback) {
    console.log('Feedback: ' + feedback.sequence);
  });
  goal.on('result', function(result) {
    console.log('Final Result: ' + result.sequence);
  });

  // Send the goal to the action server.
  goal.send();
</script>
</head>

<body>
  <h1>Fibonacci ActionClient Example</h1>
  <p>Run the following commands in the terminal then refresh this page. Check the JavaScript
    console for the output.</p>
  <ol>
    <li><tt>roscore</tt></li>
    <li><tt>rosrun actionlib_tutorials fibonacci_server</tt></li>
    <li><tt>roslaunch rosbridge_server rosbridge_websocket.launch</tt></li>
  </ol>
</body>
</html>
