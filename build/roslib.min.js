var ROSLIB=ROSLIB||{REVISION:"1"};ROSLIB.ActionClient=function(b){var c=this;b=b||{};this.ros=b.ros;this.serverName=b.serverName;this.actionName=b.actionName;this.timeout=b.timeout;this.goals={};var a=false;var d=new ROSLIB.Topic({ros:this.ros,name:this.serverName+"/feedback",messageType:this.actionName+"Feedback"});var e=new ROSLIB.Topic({ros:this.ros,name:this.serverName+"/status",messageType:"actionlib_msgs/GoalStatusArray"});var f=new ROSLIB.Topic({ros:this.ros,name:this.serverName+"/result",messageType:this.actionName+"Result"});this.goalTopic=new ROSLIB.Topic({ros:this.ros,name:this.serverName+"/goal",messageType:this.actionName+"Goal"});this.cancelTopic=new ROSLIB.Topic({ros:this.ros,name:this.serverName+"/cancel",messageType:"actionlib_msgs/GoalID"});this.cancel=function(){var g=new ROSLIB.Message({});this.cancelTopic.publish(g)};this.goalTopic.advertise();this.cancelTopic.advertise();e.subscribe(function(g){a=true;g.status_list.forEach(function(h){var i=c.goals[h.goal_id.id];if(i){i.emit("status",h)}})});d.subscribe(function(h){var g=c.goals[h.status.goal_id.id];if(g){g.emit("status",h.status);g.emit("feedback",h.feedback)}});f.subscribe(function(h){var g=c.goals[h.status.goal_id.id];if(g){g.emit("status",h.status);g.emit("result",h.result)}});if(this.timeout){setTimeout(function(){if(!a){c.emit("timeout")}},this.timeout)}};ROSLIB.ActionClient.prototype.__proto__=EventEmitter2.prototype;ROSLIB.Goal=function(b){var c=this;this.actionClient=b.actionClient;this.goalMessage=b.goalMessage;this.isFinished=false;var a=new Date();this.send=function(d){c.actionClient.goalTopic.publish(c.goalMessage);if(d){setTimeout(function(){if(!c.isFinished){c.emit("timeout")}},d)}};this.cancel=function(){var d=new ROSLIB.Message({id:c.goalID});c.actionClient.cancelTopic.publish(d)};this.goalID="goal_"+Math.random()+"_"+a.getTime();this.goalMessage=new ROSLIB.Message({goal_id:{stamp:{secs:0,nsecs:0},id:this.goalID},goal:this.goalMessage});this.on("status",function(d){this.status=d});this.on("result",function(d){this.isFinished=true;this.result=d});this.on("feedback",function(d){this.feedback=d});this.actionClient.goals[this.goalID]=this};ROSLIB.Goal.prototype.__proto__=EventEmitter2.prototype;ROSLIB.Message=function(a){var b=this;if(a){Object.keys(a).forEach(function(c){b[c]=a[c]})}};ROSLIB.Param=function(a){var b=this;a=a||{};this.name=a.name;this.get=function(e){var d=new ROSLIB.Service({name:"/rosapi/get_param",serviceType:"rosapi/GetParam"});var c=new ROSLIB.ServiceRequest({name:b.name,value:JSON.stringify("")});d.callService(c,function(f){var g=JSON.parse(f.value);e(g)})};this.set=function(e){var d=new ROSLIB.Service({name:"/rosapi/set_param",serviceType:"rosapi/SetParam"});var c=new ROSLIB.ServiceRequest({name:b.name,value:JSON.stringify(e)});d.callService(c,function(){})}};ROSLIB.Ros=function(c){var e=this;this.socket=null;function b(h){e.emit("connection",h)}function a(h){e.emit("close",h)}function d(h){e.emit("error",h)}function g(h,j){var i=new Image();i.onload=function(){var k=document.createElement("canvas");var m=k.getContext("2d");k.width=i.width;k.height=i.height;m.drawImage(i,0,0);var p=m.getImageData(0,0,i.width,i.height).data;var n="";for(var l=0;l<p.length;l+=4){n+=String.fromCharCode(p[l],p[l+1],p[l+2])}var o=JSON.parse(n);j(o)};i.src="data:image/png;base64,"+h.data}function f(h){function j(k){if(k.op==="publish"){e.emit(k.topic,k.msg)}else{if(k.op==="service_response"){e.emit(k.id,k.values)}}}var i=JSON.parse(h.data);if(i.op==="png"){g(i,function(k){j(k)})}else{j(i)}}this.connect=function(h){e.socket=new WebSocket(h);e.socket.onopen=b;e.socket.onclose=a;e.socket.onerror=d;e.socket.onmessage=f};this.close=function(){if(e.socket){e.socket.close()}};this.authenticate=function(o,i,j,l,k,n,h){var m={op:"auth",mac:o,client:i,dest:j,rand:l,t:k,level:n,end:h};callOnConnection(m)};this.callOnConnection=function(i){var h=JSON.stringify(i);if(e.socket.readyState!==WebSocket.OPEN){e.once("connection",function(){e.socket.send(h)})}else{e.socket.send(h)}};this.getTopics=function(j){var i=new ROSLIB.Service({name:"/rosapi/topics",serviceType:"rosapi/Topics"});var h=new ROSLIB.ServiceRequest();i.callService(h,function(k){j(k.topics)})};this.getServices=function(j){var i=new ROSLIB.Service({name:"/rosapi/services",serviceType:"rosapi/Services"});var h=new ROSLIB.ServiceRequest();i.callService(h,function(k){j(k.services)})};this.getParams=function(j){var h=new ROSLIB.Service({name:"/rosapi/get_param_names",serviceType:"rosapi/GetParamNames"});var i=new ROSLIB.ServiceRequest();h.callService(i,function(k){j(k.names)})};if(c){this.connect(c)}};ROSLIB.Ros.prototype.__proto__=EventEmitter2.prototype;ROSLIB.Service=function(a){var b=this;a=a||{};this.ros=a.ros;this.name=a.name;this.serviceType=a.serviceType;this.callService=function(e,f){b.ros.idCounter++;serviceCallId="call_service:"+b.name+":"+b.ros.idCounter;b.ros.once(serviceCallId,function(h){var g=new ROSLIB.ServiceResponse(h);f(g)});var c=[];Object.keys(e).forEach(function(g){c.push(e[g])});var d={op:"call_service",id:serviceCallId,service:b.name,args:c};b.ros.callOnConnection(d)}};ROSLIB.ServiceRequest=function(a){var b=this;if(a){Object.keys(a).forEach(function(c){b[c]=a[c]})}};ROSLIB.ServiceResponse=function(a){var b=this;if(a){Object.keys(a).forEach(function(c){b[c]=a[c]})}};ROSLIB.Topic=function(a){var b=this;a=a||{};this.ros=a.ros;this.name=a.name;this.messageType=a.messageType;this.isAdvertised=false;this.compression=a.compression||"none";this.throttle_rate=a.throttle_rate||0;if(this.compression&&this.compression!=="png"&&this.compression!=="none"){this.emit("warning",this.compression+" compression is not supported. No comression will be used.")}if(this.throttle_rate<0){this.emit("warning",this.throttle_rate+" is not allowed. Set to 0");this.throttle_rate=0}this.subscribe=function(e){b.on("message",function(f){e(f)});b.ros.on(b.name,function(g){var f=new ROSLIB.Message(g);b.emit("message",f)});b.ros.idCounter++;var d="subscribe:"+b.name+":"+b.ros.idCounter;var c={op:"subscribe",id:d,type:b.messageType,topic:b.name,compression:b.compression,throttle_rate:b.throttle_rate};b.ros.callOnConnection(c)};this.unsubscribe=function(){b.ros.removeAllListeners([b.name]);b.ros.idCounter++;var d="unsubscribe:"+b.name+":"+b.ros.idCounter;var c={op:"unsubscribe",id:d,topic:b.name};b.ros.callOnConnection(c)};this.advertise=function(){b.ros.idCounter++;var c="advertise:"+b.name+":"+b.ros.idCounter;var d={op:"advertise",id:c,type:b.messageType,topic:b.name};b.ros.callOnConnection(d);b.isAdvertised=true};this.unadvertise=function(){b.ros.idCounter++;var d="unadvertise:"+b.name+":"+b.ros.idCounter;var c={op:"unadvertise",id:d,topic:b.name};b.ros.callOnConnection(c);b.isAdvertised=false};this.publish=function(d){if(!b.isAdvertised){b.advertise()}b.ros.idCounter++;var e="publish:"+b.name+":"+b.ros.idCounter;var c={op:"publish",id:e,topic:b.name,msg:d};b.ros.callOnConnection(c)}};ROSLIB.Topic.prototype.__proto__=EventEmitter2.prototype;(function(a,b){if(typeof define==="function"&&define.amd){define(["robotwebtools/eventemitter2","robotwebtools/actionclient"],b)}else{a.TfClient=b(a.EventEmitter2,a.ActionClient)}}(this,function(b,g){var d=function(h){this.ros=h.ros;this.fixedFrame=h.fixedFrame||"base_link";this.angularThres=h.angularThres||2;this.transThres=h.transThres||0.01;this.rate=h.rate||10;this.goalUpdateDelay=h.goalUpdateDelay!==undefined?h.goalUpdateDelay:50;var h={ros:this.ros,serverName:h.serverName||"/tf2_web_republisher",actionName:"tf2_web_republisher/TFSubscriptionAction"};this.actionClient=new g(h);this.currentGoal=false;this.frame_infos={};this.goalUpdateRequested=false};d.prototype.__proto__=b.prototype;d.prototype.processFeedback=function(i){var h=this;i.transforms.forEach(function(j){var k=j.child_frame_id;var l=h.frame_infos[k];if(l!=undefined){l.transform=new c(j.transform.translation,j.transform.rotation);l.cbs.forEach(function(m){m(l.transform)})}})};d.prototype.requestGoalUpdate=function(){if(!this.goalUpdateRequested){setTimeout(this.updateGoal.bind(this),this.goalUpdateDelay);this.goalUpdateRequested=true;return}};d.prototype.updateGoal=function(){if(this.currentGoal){this.currentGoal.cancel()}var i={source_frames:[],target_frame:this.fixedFrame,angular_thres:this.angularThres,trans_thres:this.transThres,rate:this.rate};var h=[];for(frame in this.frame_infos){i.source_frames.push(frame)}this.currentGoal=new this.actionClient.Goal(i);this.currentGoal.on("feedback",this.processFeedback.bind(this));this.currentGoal.send();this.goalUpdateRequested=false};d.prototype.subscribe=function(h,i){if(h[0]==="/"){h=h.substring(1)}if(this.frame_infos[h]==undefined){this.frame_infos[h]={cbs:[]};this.requestGoalUpdate()}else{if(this.frame_infos[h].transform!=undefined){i(this.frame_infos[h].transform)}}this.frame_infos[h].cbs.push(i)};d.prototype.unsubscribe=function(i,k){var j=this.frame_infos[i];if(j!=undefined){var h=j.cbs.indexOf(k);if(h>=0){j.cbs.splice(h,1);if(j.cbs.length==0){delete this.frame_infos[i]}this.needUpdate=true}}};var f=d.Pose=function(h,i){this.position=new a;this.orientation=new e;if(h!==undefined){this.position.copy(h)}if(i!==undefined){this.orientation.copy(i)}};f.prototype={constructor:f,copy:function(h){this.position.copy(h.position);this.orientation.copy(h.orientation)}};var c=d.Transform=function(i,h){this.translation=new a;this.rotation=new e;if(i!==undefined){this.translation.copy(i)}if(h!==undefined){this.rotation.copy(h)}};c.prototype={constructor:c,apply:function(h){this.rotation.multiplyVec3(h.position);h.position.add(h.position,this.translation);h.orientation.multiply(this.rotation,h.orientation);return h},applyInverse:function(i){var h=this.rotation.clone().inverse();h.multiplyVec3(i.position);i.position.sub(i.position,this.translation);i.orientation.multiply(h,i.orientation);return i},copy:function(h){this.translation.copy(h.translation);this.rotation.copy(h.rotation)}};var e=d.Quaternion=function(h,k,j,i){this.x=h||0;this.y=k||0;this.z=j||0;this.w=(i!==undefined)?i:1};e.prototype={constructor:e,copy:function(h){this.x=h.x;this.y=h.y;this.z=h.z;this.w=h.w;return this},inverse:function(){this.conjugate().normalize();return this},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return this},normalize:function(){var h=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);if(h===0){this.x=0;this.y=0;this.z=0;this.w=1}else{h=1/h;this.x=this.x*h;this.y=this.y*h;this.z=this.z*h;this.w=this.w*h}return this},multiply:function(q,p){var n=q.x,m=q.y,l=q.z,o=q.w,j=p.x,i=p.y,h=p.z,k=p.w;this.x=n*k+m*h-l*i+o*j;this.y=-n*h+m*k+l*j+o*i;this.z=n*i-m*j+l*k+o*h;this.w=-n*j-m*i-l*h+o*k;return this},multiplyVec3:function(j,t){if(!t){t=j}var s=j.x,r=j.y,q=j.z,o=this.x,n=this.y,m=this.z,p=this.w;var k=p*s+n*q-m*r,i=p*r+m*s-o*q,h=p*q+o*r-n*s,l=-o*s-n*r-m*q;t.x=k*p+l*-o+i*-m-h*-n;t.y=i*p+l*-n+h*-o-k*-m;t.z=h*p+l*-m+k*-n-i*-o;return t},clone:function(){return new e(this.x,this.y,this.z,this.w)}};var a=d.Vector3=function(h,j,i){this.x=h||0;this.y=j||0;this.z=i||0};a.prototype={constructor:a,copy:function(h){this.x=h.x;this.y=h.y;this.z=h.z;return this},add:function(i,h){this.x=i.x+h.x;this.y=i.y+h.y;this.z=i.z+h.z;return this},sub:function(i,h){this.x=i.x-h.x;this.y=i.y-h.y;this.z=i.z-h.z;return this},clone:function(){return new a(this.x,this.y,this.z)}};return d}));